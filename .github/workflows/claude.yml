name: Claude Linear Analysis
on:
  workflow_dispatch:
    inputs:
      custom_prompt:
        description: 'What would you like Claude to analyze about Linear tickets?'
        required: false
        default: 'Get the latest 5 Linear tickets and summarize them with key insights'
        type: string
      max_turns:
        description: 'Maximum conversation turns for Claude'
        required: false
        default: '5'
        type: string

jobs:
  claude-linear-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create MCP configuration
        run: |
          cat > mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "linear": {
                "command": "npx",
                "args": ["-y", "@tacticlaunch/mcp-linear"],
                "env": {
                  "LINEAR_API_TOKEN": "${{ secrets.LINEAR_API_KEY }}"
                }
              }
            }
          }
          EOF

      - name: Run Claude Code Analysis
        id: claude-analysis
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Hello! I'd like you to help me analyze Linear tickets.
            
            Task: ${{ github.event.inputs.custom_prompt }}
            
            Please use the Linear MCP server to:
            1. Get information about recent Linear tickets
            2. Provide a structured analysis based on the custom prompt above
            3. Format your response in clear markdown
            
            You have access to Linear through the MCP server, so please use those tools to fetch real data.
          mcp_config: "./mcp-config.json"
          allowed_tools: "mcp__linear__*,View,Write"
          max_turns: "${{ github.event.inputs.max_turns }}"
          timeout_minutes: "10"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Create GitHub Issue with Results
        if: steps.claude-analysis.outputs.conclusion == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const executionFile = '${{ steps.claude-analysis.outputs.execution_file }}';
            const executionLog = JSON.parse(fs.readFileSync(executionFile, 'utf8'));
            
            // Extract Claude's final response
            let analysis = '';
            for (let i = executionLog.messages.length - 1; i >= 0; i--) {
              if (executionLog.messages[i].role === 'assistant') {
                analysis = executionLog.messages[i].content;
                break;
              }
            }
            
            const title = `Claude Linear Analysis - ${new Date().toISOString().split('T')[0]}`;
            const body = `# Claude Linear Analysis Report
            
            **Prompt:** "${{ github.event.inputs.custom_prompt }}"
            **Generated:** ${new Date().toISOString()}
            **Status:** ${{ steps.claude-analysis.outputs.conclusion }}
            
            ## Analysis Results
            
            ${analysis || 'No analysis content found. Check the action logs for details.'}
            
            ---
            
            ## Execution Details
            - **Max Turns:** ${{ github.event.inputs.max_turns }}
            - **Execution File:** \`${{ steps.claude-analysis.outputs.execution_file }}\`
            
            *This analysis was generated using Claude Code with Linear MCP integration.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['claude-analysis', 'linear', 'automated']
            });

      - name: Handle Analysis Failure
        if: steps.claude-analysis.outputs.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Claude Linear Analysis Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `# Claude Analysis Failed
            
            **Prompt:** "${{ github.event.inputs.custom_prompt }}"
            **Status:** failure
            **Generated:** ${new Date().toISOString()}
            
            The Claude analysis failed to complete. Please check the action logs for more details.
            
            **Execution File:** \`${{ steps.claude-analysis.outputs.execution_file }}\`
            
            *This issue was automatically created to track the failure.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['claude-analysis', 'failure', 'automated']
            });
