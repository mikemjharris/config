name: Get Latest Linear Ticket
on:
  workflow_dispatch:
    inputs:
      custom_prompt:
        description: 'Custom prompt for analyzing the Linear ticket'
        required: false
        default: 'Summarize the latest Linear ticket and provide key insights'
        type: string
      limit:
        description: 'Number of recent tickets to fetch'
        required: false
        default: '1'
        type: string

jobs:
  get-linear-ticket:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create MCP configuration
        run: |
          cat > mcp_config.json << 'EOF'
          {
            "mcpServers": {
              "linear": {
                "command": "npx",
                "args": ["-y", "@tacticlaunch/mcp-linear"],
                "env": {
                  "LINEAR_API_TOKEN": "${{ secrets.LINEAR_API_TOKEN }}"
                }
              }
            }
          }
          EOF

      - name: Create analysis prompt
        run: |
          cat > analysis_prompt.txt << 'EOF'
          Please use the Linear MCP server to:
          
          1. Get the latest ${{ github.event.inputs.limit }} Linear ticket(s)
          2. For each ticket, provide:
             - Title and ID
             - Status and priority
             - Assignee
             - Description summary
             - Any recent comments or updates
          
          Then apply this custom analysis: "${{ github.event.inputs.custom_prompt }}"
          
          Format the output in a clear, structured way that would be useful for a team update.
          EOF

      - name: Run Claude Analysis
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "10"
          mcp_config_path: "./mcp_config.json"
          prompt_file: "./analysis_prompt.txt"
        env:
          LINEAR_API_TOKEN: ${{ secrets.LINEAR_API_KEY }}

      - name: Create GitHub Issue with Results
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Linear Ticket Analysis - ${new Date().toISOString().split('T')[0]}`;
            const body = `# Linear Ticket Analysis
            
            **Custom Prompt:** ${{ github.event.inputs.custom_prompt }}
            **Tickets Analyzed:** ${{ github.event.inputs.limit }}
            **Generated:** ${new Date().toISOString()}
            
            ## Results
            
            Check the Claude action logs above for the detailed analysis.
            
            ---
            *This issue was automatically generated by the Linear ticket analysis workflow.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['linear-analysis', 'automated']
            });
