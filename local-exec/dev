#!/bin/bash

# Script to create a tmux session with multiple windows
# Each window has the same 3-pane layout (vim left, 2 vertical panes right)

session="my_dev_session"

# Configuration file for window definitions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WINDOWS_CONFIG="$SCRIPT_DIR/dev.windows"

# If config file doesn't exist, use the example
if [ ! -f "$WINDOWS_CONFIG" ]; then
    WINDOWS_CONFIG="$SCRIPT_DIR/dev.windows.example"
fi

# Read windows configuration from file
declare -a windows=()
while IFS= read -r line || [ -n "$line" ]; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

    # Expand tilde to home directory
    line="${line/#\~/$HOME}"

    windows+=("$line")
done < "$WINDOWS_CONFIG"

# Check if the session already exists
tmux has-session -t $session 2>/dev/null

# If the session doesn't exist, create it
if [ $? != 0 ]; then
    first_window=true

    for window_config in "${windows[@]}"; do
        IFS=':' read -r dir name cmd <<< "$window_config"

        if [ "$first_window" = true ]; then
            # Create the session with the first window
            tmux new-session -d -s $session -n "$name" -c "$dir"
            first_window=false
        else
            # Create additional windows (tmux auto-assigns index)
            tmux new-window -t $session -n "$name" -c "$dir"
        fi

        # Start vim in the main pane (current window)
        tmux send-keys -t $session: "vim ." C-m
        tmux select-pane -t $session: -T "📝 $name"

        # Split horizontally (30% on right)
        tmux split-window -h -p 30 -t $session: -c "$dir"

        # If there's a command for this pane, run it
        if [ -n "$cmd" ]; then
            tmux send-keys -t $session: "$cmd" C-m
        fi
        tmux select-pane -t $session: -T "🚀 Commands"

        # Split vertically (50/50) - split the current (right) pane
        tmux split-window -v -p 50 -t $session: -c "$dir"
        tmux select-pane -t $session: -T "💻 Terminal"

        # Select the vim pane (pane 1) as default for this window
        tmux select-pane -t $session:.1
    done

    # Get the first window's actual index and select it
    first_window_id=$(tmux list-windows -t $session -F "#{window_index}" | head -1)
    tmux select-window -t $session:$first_window_id
fi

# Attach to the session
tmux attach -t $session -d
